<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title><%= title %></title>
    <script type="text/javascript" src="/static/angular.min.js"></script>
    <link rel="stylesheet" type="text/css" href="/bower_components/bootstrap/css/bootstrap.css">

    <script src="/bower_components/jquery/jquery.min.js"></script>
    <script src="/bower_components/bootstrap/js/bootstrap.js"></script>

    <link rel="stylesheet" href="/bower_components/angular-color-picker/dist/angularjs-color-picker.min.css" />
    <link rel="stylesheet" href="/bower_components/angular-color-picker/dist/themes/angularjs-color-picker-bootstrap.min.css" />

    <script src="/bower_components/tinycolor/dist/tinycolor-min.js"></script>
    <script src="/bower_components/angular-color-picker/dist/angularjs-color-picker.min.js"></script>

    <link rel="stylesheet" href="/static/angular-ui-switch/angular-ui-switch.min.css"/>
    <script src="/static/angular-ui-switch/angular-ui-switch.min.js"></script>

    <style>
        span.selectedOption {
            font-weight: bold;
        }
    </style>
</head>
<body ng-app="LightManagerApp">
    <div ng-controller="LightManagerController" class="container-fluid">

        <div class="panel panel-default">

            <div class="panel-heading">
                <ul class="nav nav-pills">
                    <li class="active"><a href="#lightsTab" data-toggle="tab"><span class="glyphicon glyphicon-lamp"></span></a></li>
                    <li><a href="#programsTab" data-toggle="tab"><span class="glyphicon glyphicon-picture"></span></a></li>
                    <li><a href="#heatersTab" data-toggle="tab"><span class="glyphicon glyphicon-fire"></span></a></li>
                    <li><a href="#camerasTab" data-toggle="tab"><span class="glyphicon glyphicon-eye-open"></span></a></li>
                    <li><a href="#notificationsTab" data-toggle="tab"><span class="glyphicon glyphicon-alert"></span></a></li>
                    <li class="pull-right"><a ng-click="buildInterface()" class="glyphicon glyphicon-refresh"></a></li>
                </ul>
             </div>

            <div class="panel-body">
                <div class="tab-content">
                    <div class="tab-pane fade in active" id="lightsTab">
                        <ul class="list-group">


                            <li class="row list-group-item" ng-repeat="light in lights">
                                <div class="col-md-2 col-sm-2">
                                    {{ light.displayName }}
                                 </div>
                                <span ng-repeat="interfaceOption in light.interface">

                                    <div class="col-md-3 col-sm-3">
                                        <!-- NG MODDEL in the switch below is hardcoded, needs to be Dynamic! -->
                                        <switch
                                            ng-if="interfaceOption.type == 'switch'"
                                            id="{{ light.name }}OnOffSwitch"
                                            name="{{ light.name }}OnOffSwitch"
                                            on="{{ interfaceOption.options[0].displayName }}" off="{{ interfaceOption.options[1].displayName }}"
                                            ng-model="light.actualStatus.onOff"
                                            class="green"
                                            ng-change="sendLightCommand(light.name, interfaceOption.options[light.actualStatus.onOff == true ? 0 : 1 ].status )">
                                        </switch>
                                     </div>

                                    <div class="col-md-3 col-sm-3">
                                        <select
                                            ng-model="light.actualStatus.brightness"
                                            ng-if="interfaceOption.type == 'slider'"
                                            ng-options="x for x in [10,20,30,40,50,60,70,80,90,100]"
                                            name="{{ light.name }}{{ interfaceOption.name }}Slider"
                                            id="{{ light.name }}{{ interfaceOption.name }}Slider"
                                            ng-change="sendLightCommand(light.name , {brightness : light.actualStatus.brightness})">
                                        >
                                        </select>
                                    </div>

                                </span>
                            </li>
                        </ul>
                    </div> <!-- End of id="lightsTab" -->

                    <div class="tab-pane fade" id="programsTab">

                        <li class="row list-group-item">
                            <div class="col-md-2 col-sm-2">
                                All lights
                             </div>

                            <div class="col-md-3 col-sm-3">
                                <switch
                                    id="AllOnOffSwitch"
                                    name="AllOnOffSwitch"
                                    on="On" off="Off"
                                    class="green"
                                    ng-model="allLights.onOff"
                                    ng-change="allLights({ onOff : allLights.onOff })">
                                </switch>
                             </div>

                            <div class="col-md-3 col-sm-3">
                                <select
                                    ng-model="allLights.brightness"
                                    ng-options="x for x in [10,20,30,40,50,60,70,80,90,100]"
                                    name="allLightsBrigthnessSlider"
                                    id="allLightsBrigthnessSlider"
                                    ng-change="allLights({ brightness : allLights.brightness })">
                                >
                                </select>
                            </div>
                        </li>

                        <ng-repeat ng-repeat="program in availablePrograms">
                            <li class="row list-group-item">
                                <div class="col-md-2 col-sm-2">
                                    <a href="" ng-click="sendLightCommand(program.lights, program.status)">{{ program.name }}</a>
                                </div>
                            </li>
                        </ng-repeat>
                    </div>




                    <div class="tab-pane fade" id="notificationsTab">
                        <h3 class="panel-title">Notifications</h3>
                        <div ng-repeat="notification in notifications">
                            <div class="alert alert-{{ notification.type }}" role="alert" >
                                <span class="h4">{{ notification.title }}</span>
                                <span class="h6">{{ notification.date | date:'medium' }}</span>
                                <p>{{ notification.text }}</p>
                            </div>
                        </div>
                    </div>



                    <div class="tab-pane fade" id="camerasTab">
                        <h3 class="panel-title">Cameras</h3>
                    </div>


                    <div class="tab-pane fade" id="heatersTab">
                        <h3 class="panel-title">Heaters</h3>
                    </div>


                </div> <!-- end tab-content -->
            </div>
            <div class="panel-footer">
                Home Automation with NodeJS, Angular, LimitLess Leds and some other stuff
            </div>

        </div><!-- Closing panel panel-default -->
    </div><!-- End ng-controller LightManagerController -->


    <!-- <color-picker ng-model="myColor" options="{round : true, alpha: false }"></color-picker> -->
</body>

<script type="text/javascript">
    angular.module("LightManagerApp", ['color.picker', 'uiSwitch'])
        .controller("LightManagerController", function($scope, $http){

            $scope.allLights = {
                OnOff : true,
                brightness : 100
            }


            $scope.dimChange = function(a,b,c){ console.log(a,b,c) };

            $scope.updateInterfaceWithResponse = function(response){
                $scope.lights = response;
            }

            $scope.buildInterface = function(){
                $http.get("/angular/lights/getInterfaceOptions").success(function(response){
                    $scope.updateInterfaceWithResponse(response)
                    $scope.getNotifications();
                });
            }


            $scope.getNotifications = function(){
                $http.get("/angular/system/getNotifications").success(function(response){
                    console.log(response);
                    $scope.notifications = response;
                });
            }

            $scope.allLights = function(statusObject){
                console.log("going to send", statusObject);
                statusToSend = statusObject;
                $scope.sendLightCommand(Object.keys($scope.lights), statusToSend)
            }

            $scope.sendLightCommand = function(element, status){
                console.log("Las cosas son", element, status);
                if(typeof element == "string" || typeof element == "object"){
                    status.lightName = element;
                } else {
                    status.lightName = element.light.name;
                }

                $http.post(
                    "/angular/runProgram",
                    status
                ).success(
                     $scope.buildInterface
                )
            }

            $scope.socketSimulator = function(){
                $http.get("/angular/socketSimulator", { timeout: 60000 })
                    .success(function(response){
                        $scope.buildInterface();
                        $scope.socketSimulator()
                    })
                    .error(function(){
                        $scope.socketSimulator()
                    }
                )
            }

            $scope.getAvailablePrograms = function(){
                $http.get("/angular/lights/getAvailablePrograms").success(function(response){
                    $scope.availablePrograms = response;
                })
            }

            $scope.buildInterface();
            $scope.socketSimulator();
            $scope.getAvailablePrograms();
        });

</script>
</html>